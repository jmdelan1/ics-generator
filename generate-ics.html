<html>
<head>
    <title>Download Calendar Event</title>
    <script>
        function getQueryParam(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            var results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

function downloadICS() {
    const eventTitle = getQueryParam('title');
    const startDate = getQueryParam('start'); // Expected: YYYYMMDDTHHMMSSZ
    const endDate = getQueryParam('end');     // Expected: YYYYMMDDTHHMMSSZ
    const description = getQueryParam('desc');
    const location = getQueryParam('loc');

    // Validate required fields
    if (!eventTitle || !startDate || !endDate) {
        console.warn("Missing required parameters. ICS file will not be generated.");
        document.body.innerHTML = "<p style='font-family:sans-serif;'>Missing required calendar event details. Please check the link.</p>";
        return;
    }

    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//NASA//ICS Generator//EN
BEGIN:VEVENT
UID:${Date.now()}@nasa.gov
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'}
DTSTART:${startDate}
DTEND:${endDate}
SUMMARY:${eventTitle}
DESCRIPTION:${description || ''}
LOCATION:${location || ''}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = (eventTitle.replace(/[^a-z0-9]/gi, '_') || 'appointment') + '.ics';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Optional: Attempt to close the window after download
    setTimeout(() => window.close(), 500);
}


        window.onload = downloadICS;
    </script>
</head>
<body>
    <p>Your download should start automatically. If it doesn't, please check your browser's download section or manually download.</p>
</body>
</html>
